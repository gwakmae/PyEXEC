<Window x:Class="PyExec.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:PyExec"
        xmlns:vm="clr-namespace:PyExec.ViewModels"
        xmlns:converters="clr-namespace:PyExec.Converters"
        Title="PyExec - Script Manager" Height="800" Width="1400"
        MinHeight="700" MinWidth="1200"
        WindowStartupLocation="CenterScreen">

    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Window.InputBindings>
        <KeyBinding Command="{Binding OverwriteTemplateCommand}" Key="S" Modifiers="Control" />
    </Window.InputBindings>
    <Window.Resources>
        <converters:EqualityConverter x:Key="EqualityConverter"/>

        <Style x:Key="ActivePanelBorderStyle" TargetType="Border">
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="CornerRadius" Value="3"/>
            <Style.Triggers>
                <DataTrigger Value="True">
                    <DataTrigger.Binding>
                        <MultiBinding Converter="{StaticResource EqualityConverter}">
                            <Binding />
                            <Binding Path="DataContext.ActivePanelVM" RelativeSource="{RelativeSource AncestorType=Window}"/>
                        </MultiBinding>
                    </DataTrigger.Binding>
                    <Setter Property="BorderBrush" Value="DodgerBlue"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="Button">
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Margin" Value="5"/>
        </Style>
        <converters:FileContentConverter x:Key="FileContentConverter"/>
    </Window.Resources>

    <DockPanel>
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_File">
                <MenuItem Header="_Add Program" Command="{Binding AddProgramCommand}"/>
                <MenuItem Header="_Remove Program" Command="{Binding RemoveProgramCommand}"/>
                <Separator/>
                <MenuItem Header="_New Template" Command="{Binding NewTemplateCommand}"/>
                <MenuItem Header="Save _Template" Command="{Binding SaveTemplateCommand}"/>
                <MenuItem Header="Load T_emplate" Command="{Binding LoadTemplateCommand}"/>
                <MenuItem Header="Remove Recent Tem_plate" Command="{Binding RemoveRecentTemplateCommand}"/>
                <Separator/>
                <MenuItem Header="E_xit" Command="{Binding ExitCommand}"/>
            </MenuItem>
            <MenuItem Header="_Tools">
                <MenuItem Header="Set _Default VirtualEnv Folder" Command="{Binding SetDefaultVenvCommand}"/>
                <Separator/>
                <MenuItem Header="Set VirtualEnv for Selected..." Command="{Binding SetVenvForSelectedCommand}"/>
                <Separator/>
                <MenuItem Header="Set to run with 'uv run'" Command="{Binding SetRunUvCommand}"/>
                <MenuItem Header="Set to run with 'python'" Command="{Binding SetRunPythonCommand}"/>
                <Separator/>
                <MenuItem Header="Open CMD (Default Venv)" Command="{Binding OpenCmdDefaultVenvCommand}"/>
                <MenuItem Header="Open CMD (Selected Program Venv)" Command="{Binding OpenCmdSelectedVenvCommand}"/>
                <Separator/>
                <MenuItem Header="Convert .py to/from .pyw" Command="{Binding ConvertPyPywCommand}"/>
                <MenuItem Header="Apply Name to Description" Command="{Binding ApplyNameToDescriptionCommand}"/>
                <MenuItem Header="Apply FolderName to Description" Command="{Binding ApplyFolderNameToDescriptionCommand}"/>
                <Separator/>
                <MenuItem Header="스크립트 출력 로그 표시(_L)" IsCheckable="True" IsChecked="{Binding ShowScriptOutput, Mode=TwoWay}"/>
                <Separator/>
                <MenuItem Header="프로세스 시작 정보(_I)" Command="{Binding ShowProcessStartInfoCommand}"/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_About" Command="{Binding AboutCommand}"/>
            </MenuItem>
        </Menu>

        <Label Content="{Binding VirtualEnvInfo}" DockPanel.Dock="Top" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10" FontSize="14" FontWeight="Bold"/>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition x:Name="TemplatesRow" Height="150" MinHeight="80"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Background="#FFEFEFEF" Padding="5" Margin="5,0,5,0">
                <DockPanel>
                    <DockPanel DockPanel.Dock="Top" Margin="0,0,0,5">
                        <Label Content="Recent Templates:" FontWeight="Bold" VerticalAlignment="Center" DockPanel.Dock="Left"/>
                        <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Content="▲ Up" ToolTip="Move selected template up" Background="LightBlue" Margin="5,0,5,0" Command="{Binding MoveTemplateUpCommand}"/>
                            <Button Content="▼ Down" ToolTip="Move selected template down" Background="LightBlue" Margin="5,0,5,0" Command="{Binding MoveTemplateDownCommand}"/>
                        </StackPanel>
                    </DockPanel>
                    <DataGrid x:Name="RecentTemplatesGrid"
                              ItemsSource="{Binding RecentTemplates}"
                              SelectedItem="{Binding SelectedRecentTemplate, Mode=TwoWay}"
                              MouseDoubleClick="RecentTemplatesGrid_MouseDoubleClick"
                              AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False"
                              SelectionMode="Single" SelectionUnit="FullRow" IsReadOnly="True">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Template Path" Binding="{Binding}" Width="*" IsReadOnly="True"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>

            <GridSplitter Grid.Row="1" Height="5" HorizontalAlignment="Stretch" VerticalAlignment="Center" ResizeBehavior="PreviousAndNext" Background="LightGray"/>

            <Grid Grid.Row="2">
                <Grid.RowDefinitions>
                    <RowDefinition x:Name="ProgramView1Row" Height="*" MinHeight="150"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition x:Name="ProgramView2Row" Height="*" MinHeight="150"/>
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Margin="10,5,10,5"
                        x:Name="View1"
                        DataContext="{Binding Panel1VM}"
                        Focusable="True"
                        GotFocus="ProgramView_GotFocus"
                        Style="{StaticResource ActivePanelBorderStyle}">

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition x:Name="View1_ListColumn" Width="3*"/>
                            <ColumnDefinition Width="5"/>
                            <ColumnDefinition x:Name="View1_CodeColumn" Width="2*"/>
                        </Grid.ColumnDefinitions>

                        <DockPanel Grid.Column="0">
                            <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,5,0,0">
                                <Button Content="▲ Move Selected Up" ToolTip="Move Selected Row Up (Ctrl+Up)" Command="{Binding MoveUpCommand}"/>
                                <Button Content="▼ Move Selected Down" ToolTip="Move Selected Row Down (Ctrl+Down)" Command="{Binding MoveDownCommand}"/>
                            </StackPanel>
                            <DataGrid ItemsSource="{Binding Programs}" SelectedItem="{Binding SelectedProgram, Mode=TwoWay}" AutoGenerateColumns="False" SelectionMode="Extended" CanUserAddRows="False" SelectionUnit="FullRow"
                                      MouseDoubleClick="ProgramGrid_MouseDoubleClick">
                                <DataGrid.InputBindings>
                                    <KeyBinding Key="F5" Command="{Binding RunProgramCommand}"/>
                                </DataGrid.InputBindings>
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="No." Binding="{Binding Order}" Width="50" IsReadOnly="True">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="TextAlignment" Value="Center" />
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="150"/>
                                    <DataGridTextColumn Header="Name" Binding="{Binding Name}" IsReadOnly="True" Width="120"/>
                                    <DataGridTextColumn Header="Category" Binding="{Binding Category}" Width="100"/>
                                    <DataGridTextColumn Header="Runner" Binding="{Binding RunnerDisplay}" IsReadOnly="True" Width="80"/>
                                    <DataGridTextColumn Header="Path" Binding="{Binding Path}" IsReadOnly="True" Width="*"/>
                                    <DataGridTextColumn Header="VirtualEnv Folder" Binding="{Binding DisplayVirtualEnvPath}" IsReadOnly="True" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </DockPanel>

                        <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch"/>

                        <DockPanel Grid.Column="2">
                            <Label Content="Python Code" DockPanel.Dock="Top" FontWeight="Bold" FontSize="14"/>
                            <Button Content="Run Program (F5)" DockPanel.Dock="Top" Background="LightGreen" FontWeight="Bold" Command="{Binding RunProgramCommand}"/>
                            <TextBox IsReadOnly="True" FontFamily="Consolas" FontSize="12" AcceptsReturn="True"
                                     VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto" Margin="0,5"
                                     Text="{Binding SelectedProgram.Path, Converter={StaticResource FileContentConverter}, Mode=OneWay}"/>
                        </DockPanel>
                    </Grid>
                </Border>

                <GridSplitter Grid.Row="1" Height="5" HorizontalAlignment="Stretch" VerticalAlignment="Center" ResizeBehavior="PreviousAndNext" Background="LightGray"/>

                <Border Grid.Row="2" Margin="10,5,10,10"
                        x:Name="View2"
                        DataContext="{Binding Panel2VM}"
                        Focusable="True"
                        GotFocus="ProgramView_GotFocus"
                        Style="{StaticResource ActivePanelBorderStyle}">

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition x:Name="View2_ListColumn" Width="3*"/>
                            <ColumnDefinition Width="5"/>
                            <ColumnDefinition x:Name="View2_CodeColumn" Width="2*"/>
                        </Grid.ColumnDefinitions>

                        <DockPanel Grid.Column="0">
                            <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,5,0,0">
                                <Button Content="▲ Move Selected Up" ToolTip="Move Selected Row Up" Command="{Binding MoveUpCommand}"/>
                                <Button Content="▼ Move Selected Down" ToolTip="Move Selected Row Down" Command="{Binding MoveDownCommand}"/>
                            </StackPanel>
                            <DataGrid ItemsSource="{Binding Programs}" SelectedItem="{Binding SelectedProgram, Mode=TwoWay}" AutoGenerateColumns="False" SelectionMode="Extended" CanUserAddRows="False" SelectionUnit="FullRow"
                                      MouseDoubleClick="ProgramGrid_MouseDoubleClick">
                                <DataGrid.InputBindings>
                                    <KeyBinding Key="F5" Command="{Binding RunProgramCommand}"/>
                                </DataGrid.InputBindings>
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="No." Binding="{Binding Order}" Width="50" IsReadOnly="True">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="TextAlignment" Value="Center" />
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="150"/>
                                    <DataGridTextColumn Header="Name" Binding="{Binding Name}" IsReadOnly="True" Width="120"/>
                                    <DataGridTextColumn Header="Category" Binding="{Binding Category}" Width="100"/>
                                    <DataGridTextColumn Header="Runner" Binding="{Binding RunnerDisplay}" IsReadOnly="True" Width="80"/>
                                    <DataGridTextColumn Header="Path" Binding="{Binding Path}" IsReadOnly="True" Width="*"/>
                                    <DataGridTextColumn Header="VirtualEnv Folder" Binding="{Binding DisplayVirtualEnvPath}" IsReadOnly="True" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </DockPanel>

                        <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch"/>

                        <DockPanel Grid.Column="2">
                            <Label Content="Python Code" DockPanel.Dock="Top" FontWeight="Bold" FontSize="14"/>
                            <Button Content="Run Program (F5)" DockPanel.Dock="Top" Background="LightGreen" FontWeight="Bold" Command="{Binding RunProgramCommand}"/>
                            <TextBox IsReadOnly="True" FontFamily="Consolas" FontSize="12" AcceptsReturn="True"
                                     VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto" Margin="0,5"
                                     Text="{Binding SelectedProgram.Path, Converter={StaticResource FileContentConverter}, Mode=OneWay}"/>
                        </DockPanel>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </DockPanel>
</Window>